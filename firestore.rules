rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // CONVERSATIONS - Lead can read their own conversations
    // ========================================
    match /conversations/{conversationId} {
      // Allow read if the user is a participant
      allow read: if request.auth != null 
                  && request.auth.uid in resource.data.participants;
      
      // Only server-side (Admin SDK) can write conversations
      allow write: if false;
      
      // ========================================
      // MESSAGES - Subcollection of conversations
      // ========================================
      match /messages/{messageId} {
        // Allow read if user is a participant of the parent conversation
        allow read: if request.auth != null 
                    && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        // Allow leads to create messages (send messages)
        allow create: if request.auth != null 
                      && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants
                      && request.resource.data.senderId == request.auth.uid;
        
        // No update or delete allowed from client
        allow update, delete: if false;
      }
    }
    
    // ========================================
    // LEADS - Only server-side access
    // ========================================
    match /leads/{leadId} {
      allow read, write: if false; // Admin SDK only
    }
    
    // ========================================
    // MAIL - Trigger Email Extension collection
    // Only Admin SDK should write to this collection
    // ========================================
    match /mail/{mailId} {
      allow read, write: if false; // Admin SDK only
    }
    
    // ========================================
    // DEFAULT - Deny all other access
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
